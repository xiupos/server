- name: Apply Common Configuration
  hosts: all
  become: true
  roles:
    - common

- name: Install k3s
  ansible.builtin.import_playbook: k3s.orchestration.site

- name: Post-install security tasks for k3s
  hosts: all
  become: true
  tasks:
    - name: Close unsafe k8s ports on public interface
      ansible.builtin.import_role:
        name: common
        tasks_from: close-k8s-ports

- name: Fetch and modify k3s config
  hosts: server
  become: true
  gather_facts: true
  tasks:
    - name: Read k3s.yaml from remote
      ansible.builtin.slurp:
        src: /etc/rancher/k3s/k3s.yaml
      register: remote_k3s_config

    - name: Save to local ~/.kube/config-<hostname>
      ansible.builtin.copy:
        content: "{{ remote_k3s_config['content'] | b64decode | replace('127.0.0.1', ansible_host) }}"
        dest: "~/.kube/config-{{ inventory_hostname }}"
        mode: "0600"
      delegate_to: localhost
      become: false

# - name: Install ArgoCD
#   hosts: server
#   become: true
#   roles:
#     - argocd
